<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ğŸ´ Tarot</title>
<style>
:root{
  --bg1:#f9f9ff;--bg2:#eef2ff;--bg3:#e0e7ff;
  --glass:rgba(255,255,255,.35);--line:rgba(255,255,255,.45);
  --text:#1e1b4b;--muted:#5b5b8a;--accent:#a78bfa;--gold:#fcd34d;
}
*{box-sizing:border-box}
html,body{
  height:100%;margin:0;color:var(--text);
  background:
    radial-gradient(150% 150% at 80% 10%, #a5b4fc 0%, transparent 40%),
    radial-gradient(150% 150% at 20% 90%, #fbcfe8 0%, transparent 40%),
    linear-gradient(135deg,var(--bg1),var(--bg2) 40%, var(--bg3));
  font-family:"Poppins","PingFang SC","Microsoft YaHei",sans-serif;
  overflow:hidden;
}
.wrap{height:100%;display:grid;place-items:center;padding:24px}
.board{width:min(980px,96vw)}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
header h1{margin:0;font-size:clamp(20px,3.4vw,36px);letter-spacing:.5px;
  background:linear-gradient(90deg,#8b5cf6,#0ea5e9);
  -webkit-background-clip:text;color:transparent;}
.chip{background:var(--glass);padding:8px 12px;border-radius:999px;color:var(--muted);
  font-weight:700;backdrop-filter:blur(12px);border:1px solid var(--line)}
.panel{background:var(--glass);border:1px solid var(--line);border-radius:20px;
  box-shadow:0 20px 60px rgba(180,180,255,.3),inset 0 0 0 1px rgba(255,255,255,.5);
  backdrop-filter:blur(16px)}
.stage{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
.table{height:520px;position:relative;overflow:hidden;border-radius:20px;}
.felt{
  position:absolute;inset:0;
  background:
    radial-gradient(100% 120% at 50% 10%, rgba(255,255,255,.8), rgba(230,230,255,.4)),
    linear-gradient(135deg, rgba(255,255,255,.7), rgba(220,240,255,.4));
  /* NEW: ensure it never blocks clicks */
  pointer-events:none;
}
.light{
  position:absolute;inset:auto 0 0 0;height:140px;filter:blur(40px);opacity:.7;
  background:radial-gradient(closest-side, rgba(167,139,250,.35), transparent 80%);
  /* NEW: ensure it never blocks clicks */
  pointer-events:none;
}
.deckArea{position:absolute;left:50%;top:54%;transform:translate(-50%,-50%);
  width:640px;height:380px;perspective:1200px;}
.deck{position:absolute;inset:0;transform-style:preserve-3d;
  /* NEW: keep cards on top of felt/light */
  z-index:10;}
.card{
  position:absolute;width:180px;height:260px;border-radius:18px;padding:14px;
  display:flex;flex-direction:column;justify-content:space-between;align-items:flex-start;
  color:#1e1b4b;font-weight:900;
  background:linear-gradient(145deg,#fff,#f0f7ff 60%,#fafaff);
  box-shadow:0 12px 40px rgba(200,200,255,.35);
  transform-style:preserve-3d;backface-visibility:hidden;
  transition:transform .25s ease, box-shadow .3s ease, filter .3s ease, opacity .4s ease;
  cursor:pointer;
}
.card.back{
  background:
    radial-gradient(120% 100% at 30% 20%, rgba(255,255,255,.9), rgba(230,230,255,.25)),
    repeating-radial-gradient(circle at 50% 50%, rgba(167,139,250,.25) 0 2px, transparent 2px 6px),
    linear-gradient(145deg,rgba(255,255,255,0.65),rgba(230,230,255,0.2));
  border:1px solid rgba(255,255,255,0.5);
  box-shadow:0 8px 24px rgba(180,180,255,.35),inset 0 0 60px rgba(255,255,255,.4);
  backdrop-filter:blur(8px);
}
.card.back .tag,.card.back .title,.card.back .tiny{display:none}
.card .sigil{
  position:absolute;inset:0;display:grid;place-items:center;
  font-size:40px;letter-spacing:4px;color:#6b7280;opacity:.6;
  text-shadow:0 1px 0 rgba(255,255,255,.5);
}
.card.selected{box-shadow:0 0 0 3px var(--gold), 0 12px 40px rgba(252,211,77,.45)!important; transform:translateY(-6px)}
.card.focused{transform:scale(1.08);}
.card .tag{font-size:12px;letter-spacing:.6px;color:#64748b;opacity:.8}
.card .title{font-size:18px;line-height:1.15}
.card .emoji{font-size:36px}
.card .tiny{font-size:12px;font-weight:700;color:#6b7280}
.card::after{content:"";position:absolute;inset:0;border-radius:18px;
  box-shadow:inset 0 0 0 2px rgba(255,255,255,.4),inset 0 -120px 120px rgba(147,197,253,.16);}
.shadow{position:absolute;width:180px;height:24px;left:0;top:0;
  transform:translate(-50%,-50%);border-radius:50%;
  background:radial-gradient(closest-side,rgba(255,255,255,.45),transparent 65%);
  filter:blur(6px);opacity:0.4;pointer-events:none;}
.ctrl{padding:16px;display:flex;flex-direction:column;gap:12px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.btn{appearance:none;border:none;border-radius:12px;padding:12px 16px;font-weight:900;
  letter-spacing:.4px;cursor:pointer;color:#1e1b4b;
  background:linear-gradient(180deg,#fde68a,#fcd34d);
  box-shadow:0 8px 20px rgba(250,204,21,.35);
  transition:transform .15s ease;}
.btn:hover{transform:translateY(-2px)}
.btn.secondary{
  background:linear-gradient(180deg,#c7d2fe,#a5b4fc);
  box-shadow:0 8px 20px rgba(147,197,253,.35);
}
.btn.good{background:linear-gradient(180deg,#86efac,#34d399); box-shadow:0 8px 20px rgba(52,211,153,.35)}
.label{min-width:80px;color:var(--muted)}
input[type=range]{border-radius:10px;padding:0;width:160px;background:transparent}
.log{padding:10px 14px;border-radius:12px;background:rgba(255,255,255,.4);
  font-size:13px;color:#1e1b4b;}
footer{margin-top:12px;display:flex;align-items:center;justify-content:space-between;color:#4b5563}
.kv{margin-top:6px;font-size:13px;color:#374151}
.kv b{color:#111827}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;
  border:1px solid rgba(255,255,255,.55);background:rgba(255,255,255,.4); font-size:12px}
.badge .dot{width:8px;height:8px;border-radius:50%;background:#10b981}
</style>
</head>
<body>
<div class="wrap">
  <div class="board">
    <header>
      <h1>ğŸ´ Tarot</h1>
      <div class="chip" id="status">è½»æŒ‰å¼€å§‹ï¼Œå€¾å¬å¿ƒæ„</div>
    </header>
    <div class="stage">
      <section class="panel table">
        <div class="felt"></div>
        <div class="deckArea"><div class="deck" id="deck"></div></div>
        <div class="light"></div>
      </section>
      <section class="panel ctrl">
        <div class="row">
          <span class="label">æŒ‡å¼•ï¼š</span>
          <span class="badge"><span class="dot"></span>å‘ 5 å¼ èƒŒé¢å¡ â†’ ç›´è§‰ç‚¹é€‰ 3 å¼  â†’ æœªé€‰è½»è½ â†’ é€‰ä¸­ç¿»å¼€å‘ˆç°</span>
        </div>
        <div class="row">
          <button class="btn" id="deal">ğŸƒ å‘ 5 å¼ </button>
          <button class="btn secondary" id="reset">â™»ï¸ é‡æ–°æ¥è¿‡</button>
          <button class="btn good" id="next" disabled>â¡ï¸ è¿›å…¥å¯¹è¯</button>
        </div>
        <div class="row">
          <span class="label">åŠ¨ç”»ï¼š</span>
          <input id="speed" type="range" min="0.5" max="2.0" step="0.1" value="1.0"/><span id="speedVal">1.0Ã—</span>
        </div>
        <div class="log" id="log">æ·±å‘¼å¸ï¼Œä¸“æ³¨ä½ çš„å½“ä¸‹é—®é¢˜ã€‚éšæ‰‹æŠ½ç‰Œï¼Œå¬å¿ƒçš„ç­”æ¡ˆã€‚</div>
        <div class="kv" id="kv"></div>
        <script id="tarot_picks_json" type="application/json">{}</script>
      </section>
    </div>
    <footer><div>ç›´è§‰ä¸ºç¯</div><div>5 é€‰ 3 Â· é¢æœä¸‹é€‰æ‹©</div></footer>
  </div>
</div>

<script>
/* ====== è·¯å¾„é…ç½® ====== */
const TAROT_JSON_URL = "./Cards.json";      // â† æ”¹ä¸ºç›¸å¯¹è·¯å¾„
const RAG_HTML_URL   = "./tarot_rag.html";  // â† æ”¹ä¸ºç›¸å¯¹è·¯å¾„
const BACKEND_URL    = "";                  // â† æ— åç«¯æ—¶ç•™ç©ºå³å¯

/* ====== ä¼šè¯ ====== */
function getOrCreateRuntimeId(){
  const k = 'tarot_runtime_id';
  const old = localStorage.getItem(k);
  if (old) return old;
  const id = 'run-' + Date.now();
  localStorage.setItem(k, id);
  return id;
}
function newDialogId(){
  return 'dlg-' + Math.random().toString(36).slice(2,8) + '-' + Date.now().toString().slice(-6);
}
let RUNTIME_ID = getOrCreateRuntimeId();
let DIALOG_ID  = newDialogId();

/* ====== åå¤‡æ¼”ç¤ºå¡ç»„ ====== */
const FALLBACK_JSON = {
  "Major_Arcana": [
    {"number": 0, "name_en": "The Fool", "name_zh": "æ„šè€…", "upright": "æ–°çš„å¼€å§‹ã€å†’é™©ã€å¤©çœŸã€ä¿¡ä»»ç›´è§‰", "reversed": "é²è½ã€é€ƒé¿ç°å®ã€ç¼ºä¹è®¡åˆ’"},
    {"number": 1, "name_en": "The Magician", "name_zh": "é­”æœ¯å¸ˆ", "upright": "åˆ›é€ åŠ›ã€æ„å¿—ã€æŒæ§ã€å®ç°æ½œèƒ½", "reversed": "æ¬ºéª—ã€æ»¥ç”¨èƒ½åŠ›ã€ç¼ºä¹è‡ªä¿¡"},
    {"number": 2, "name_en": "The High Priestess", "name_zh": "å¥³ç¥­å¸", "upright": "ç›´è§‰ã€æ½œæ„è¯†ã€æ™ºæ…§ã€ç¥ç§˜", "reversed": "å‹æŠ‘æƒ…æ„Ÿã€è¯¯å¯¼ã€ç§˜å¯†æ›å…‰"},
    {"number": 3, "name_en": "The Empress", "name_zh": "çš‡å", "upright": "ä¸°é¥¶ã€æ¯æ€§ã€ç¾æ„Ÿã€åˆ›é€ ", "reversed": "ä¾èµ–ã€æ‡’æ•£ã€è¿‡åº¦ä¿æŠ¤"},
    {"number": 4, "name_en": "The Emperor", "name_zh": "çš‡å¸", "upright": "æƒå¨ã€ç»“æ„ã€é¢†å¯¼ã€ç¨³å®š", "reversed": "ç‹¬è£ã€å‹æŠ‘ã€æ»¥ç”¨æƒåŠ›"},
    {"number": 5, "name_en": "The Hierophant", "name_zh": "æ•™çš‡", "upright": "ä¼ ç»Ÿã€ä¿¡ä»°ã€å­¦ä¹ ã€æŒ‡å¯¼", "reversed": "ç›²ä»ã€è´¨ç–‘ä¼ ç»Ÿã€æ€æƒ³åƒµåŒ–"},
    {"number": 6, "name_en": "The Lovers", "name_zh": "æ‹äºº", "upright": "çˆ±æƒ…ã€é€‰æ‹©ã€å’Œè°å…³ç³»", "reversed": "è¯¯ä¼šã€è¯±æƒ‘ã€åˆ†æ­§"},
    {"number": 7, "name_en": "The Chariot", "name_zh": "æˆ˜è½¦", "upright": "èƒœåˆ©ã€æ§åˆ¶ã€è‡ªå¾‹ã€æ„å¿—åŠ›", "reversed": "å¤±æ§ã€å†²åŠ¨ã€æ–¹å‘ä¸æ˜"},
    {"number": 8, "name_en": "Strength", "name_zh": "åŠ›é‡", "upright": "å‹‡æ°”ã€è‡ªä¿¡ã€è€å¿ƒã€å†…åœ¨åŠ›é‡", "reversed": "ææƒ§ã€è„†å¼±ã€è‡ªæˆ‘æ€€ç–‘"},
    {"number": 9, "name_en": "The Hermit", "name_zh": "éšè€…", "upright": "å†…çœã€ç‹¬å¤„ã€æ™ºæ…§ã€çœŸç†æ¢ç´¢", "reversed": "å­¤ç«‹ã€é€ƒé¿ã€è¿·èŒ«"},
    {"number": 10, "name_en": "Wheel of Fortune", "name_zh": "å‘½è¿ä¹‹è½®", "upright": "æœºé‡ã€å¾ªç¯ã€å‘½è¿è½¬æŠ˜", "reversed": "å„è¿ã€æŠ—æ‹’æ”¹å˜ã€å¤±æ§"},
    {"number": 11, "name_en": "Justice", "name_zh": "æ­£ä¹‰", "upright": "å…¬å¹³ã€çœŸç›¸ã€å› æœã€å¹³è¡¡", "reversed": "åè§ã€ä¸å…¬ã€é€ƒé¿è´£ä»»"},
    {"number": 12, "name_en": "The Hanged Man", "name_zh": "å€’åŠäºº", "upright": "ç‰ºç‰²ã€æ”¾ä¸‹ã€è½¬æ¢è§†è§’", "reversed": "å›ºæ‰§ã€é€ƒé¿ç‰ºç‰²ã€åœæ»ä¸å‰"},
    {"number": 13, "name_en": "Death", "name_zh": "æ­»äº¡", "upright": "ç»“æŸä¸é‡ç”Ÿã€è½¬å˜ã€æ”¾ä¸‹è¿‡å»", "reversed": "æŠ—æ‹’æ”¹å˜ã€å»¶è¿Ÿç»“æŸ"},
    {"number": 14, "name_en": "Temperance", "name_zh": "èŠ‚åˆ¶", "upright": "å¹³è¡¡ã€åè°ƒã€ç–—æ„ˆã€è€å¿ƒ", "reversed": "å¤±è¡¡ã€æç«¯ã€å†²çª"},
    {"number": 15, "name_en": "The Devil", "name_zh": "æ¶é­”", "upright": "æŸç¼šã€æ¬²æœ›ã€è¯±æƒ‘ã€ç‰©è´¨ä¸»ä¹‰", "reversed": "è§‰é†’ã€è§£æ”¾ã€æ‘†è„±æˆç˜¾"},
    {"number": 16, "name_en": "The Tower", "name_zh": "é«˜å¡”", "upright": "çªå˜ã€å´©å¡Œã€çœŸç›¸æ­éœ²", "reversed": "æ‹–å»¶ç¾éš¾ã€å¦è®¤ç°å®"},
    {"number": 17, "name_en": "The Star", "name_zh": "æ˜Ÿæ˜Ÿ", "upright": "å¸Œæœ›ã€ç–—æ„ˆã€çµæ„Ÿã€ä¿¡ä»»æœªæ¥", "reversed": "å¤±æœ›ã€æ€€ç–‘ã€è‡ªæ€œ"},
    {"number": 18, "name_en": "The Moon", "name_zh": "æœˆäº®", "upright": "ç›´è§‰ã€å¹»è§‰ã€æ½œæ„è¯†ã€æ¢¦å¢ƒ", "reversed": "æ··ä¹±ã€æ¬ºéª—ã€ç„¦è™‘"},
    {"number": 19, "name_en": "The Sun", "name_zh": "å¤ªé˜³", "upright": "æˆåŠŸã€å¿«ä¹ã€æ´»åŠ›ã€æ¸…æ™°", "reversed": "å»¶è¿Ÿã€éª„å‚²ã€è™šä¼ªçš„å¿«ä¹"},
    {"number": 20, "name_en": "Judgement", "name_zh": "å®¡åˆ¤", "upright": "è§‰é†’ã€æ•‘èµã€åæ€ã€è‡ªæˆ‘è¯„ä¼°", "reversed": "åæ‚”ã€è‡ªæˆ‘å¦å®šã€æ‹’ç»æ”¹å˜"},
    {"number": 21, "name_en": "The World", "name_zh": "ä¸–ç•Œ", "upright": "å®Œæˆã€åœ†æ»¡ã€æˆå°±ã€æ•´åˆ", "reversed": "åœæ»ã€æœªå®Œæˆã€ç¼ºä¹é—­åˆ"}
  ],
  "Minor_Arcana": {
    "Wands": [
      {"name": "Ace of Wands", "upright": "çµæ„Ÿã€æœºé‡ã€åˆ›æ„çš„å¼€ç«¯", "reversed": "æ–¹å‘ä¸æ˜ã€å»¶è¿Ÿã€ç¼ºä¹åŠ¨åŠ›"},
      {"name": "Two of Wands", "upright": "è®¡åˆ’ã€è¿œè§ã€é€‰æ‹©", "reversed": "çŠ¹è±«ã€ä¸å®‰ã€ç¼ºä¹å†³æ–­"},
      {"name": "Three of Wands", "upright": "è¿œæ™¯ã€æ‰©å±•ã€æˆåŠŸçš„æœŸæœ›", "reversed": "å»¶è¿Ÿã€å—é˜»ã€çŸ­è§†"},
      {"name": "Four of Wands", "upright": "åº†ç¥ã€å®‰å®šã€å®¶åº­å’Œè°", "reversed": "ä¸å®‰ã€æš‚æ—¶çš„å¹³é™"},
      {"name": "Five of Wands", "upright": "ç«äº‰ã€å†²çªã€æŒ‘æˆ˜", "reversed": "é¿å…å†²çªã€æ··ä¹±ã€åˆ†è£‚"},
      {"name": "Six of Wands", "upright": "èƒœåˆ©ã€è®¤å¯ã€è‡ªä¿¡", "reversed": "å¤±è´¥ã€éª„å‚²ã€å¤±æœ›"},
      {"name": "Seven of Wands", "upright": "é˜²å¾¡ã€åšæŒã€å‹‡æ°”", "reversed": "æ”¾å¼ƒã€çŠ¹è±«ã€é˜²å¾¡å¤±è´¥"},
      {"name": "Eight of Wands", "upright": "å¿«é€Ÿè¡ŒåŠ¨ã€æ—…è¡Œã€è¿›å±•", "reversed": "å»¶è¿Ÿã€æ··ä¹±ã€éšœç¢"},
      {"name": "Nine of Wands", "upright": "åšéŸ§ã€é˜²å¾¡ã€æ¯…åŠ›", "reversed": "ç–²æƒ«ã€å€¦æ€ ã€æ”¾å¼ƒ"},
      {"name": "Ten of Wands", "upright": "è´Ÿæ‹…ã€è´£ä»»ã€åŠªåŠ›è¾¾æˆ", "reversed": "å‹åŠ›è¿‡å¤§ã€å´©æºƒã€é€ƒé¿"},
      {"name": "Page of Wands", "upright": "çƒ­æƒ…ã€å­¦ä¹ æ–°äº‹ç‰©ã€åˆ›é€ æ€§æƒ³æ³•", "reversed": "å¹¼ç¨šã€é²è½ã€è½»ç‡"},
      {"name": "Knight of Wands", "upright": "å†’é™©ã€æ¿€æƒ…ã€è¡ŒåŠ¨", "reversed": "å†²åŠ¨ã€ä¸å®‰ã€æ— ç›®æ ‡"},
      {"name": "Queen of Wands", "upright": "è‡ªä¿¡ã€é­…åŠ›ã€é¢†å¯¼åŠ›", "reversed": "å«‰å¦’ã€è™šä¼ªã€è‡ªæˆ‘ä¸­å¿ƒ"},
      {"name": "King of Wands", "upright": "è¿œè§ã€æ¿€åŠ±ä»–äººã€æŒæ§å±€é¢", "reversed": "å‚²æ…¢ã€å†²åŠ¨ã€æ»¥ç”¨æƒåŠ›"}
    ],
    "Cups": [
      {"name": "Ace of Cups", "upright": "æƒ…æ„Ÿæ–°ç”Ÿã€çˆ±ã€ç›´è§‰", "reversed": "æƒ…æ„Ÿå‹æŠ‘ã€åˆ†ç¦»ã€å†·æ¼ "},
      {"name": "Two of Cups", "upright": "ç»“åˆã€ä¼™ä¼´å…³ç³»ã€çˆ±æƒ…", "reversed": "è¯¯ä¼šã€äº‰æ‰§ã€å…³ç³»ç ´è£‚"},
      {"name": "Three of Cups", "upright": "å‹è°Šã€åº†ç¥ã€ç¤¾äº¤", "reversed": "è¿‡åº¦ä¾èµ–ã€èƒŒå›ã€åˆ†è£‚"},
      {"name": "Four of Cups", "upright": "æ²‰æ€ã€ä¸æ»¡ã€å†…çœ", "reversed": "è§‰é†’ã€é‡æ–°å¼€å§‹ã€æœºä¼š"},
      {"name": "Five of Cups", "upright": "å¤±è½ã€æ‚²ä¼¤ã€åæ‚”", "reversed": "é‡Šæ€€ã€é‡æ–°æŒ¯ä½œã€å¸Œæœ›"},
      {"name": "Six of Cups", "upright": "æ€€æ—§ã€å›å¿†ã€ç«¥å¹´", "reversed": "é€ƒé¿ç°å®ã€è¿‡åº¦æ²‰æººè¿‡å»"},
      {"name": "Seven of Cups", "upright": "å¹»æƒ³ã€è¯±æƒ‘ã€é€‰æ‹©", "reversed": "æ¸…é†’ã€ç°å®ã€ä¸“æ³¨"},
      {"name": "Eight of Cups", "upright": "ç¦»å¼€ã€å¯»æ‰¾çœŸç†ã€æ”¾å¼ƒ", "reversed": "çŠ¹è±«ã€é€ƒé¿ã€å›å¤´"},
      {"name": "Nine of Cups", "upright": "æ»¡è¶³ã€å¹¸ç¦ã€æ„¿æœ›æˆçœŸ", "reversed": "è´ªå©ªã€è‡ªæ»¡ã€ä¸æ»¡è¶³"},
      {"name": "Ten of Cups", "upright": "å¹¸ç¦å®¶åº­ã€å’Œè°ã€åœ†æ»¡", "reversed": "ä¸å’Œã€ç ´è£‚ã€è™šä¼ªå¹¸ç¦"},
      {"name": "Page of Cups", "upright": "åˆ›æ„ã€æµªæ¼«ã€æƒ…æ„Ÿå¯è’™", "reversed": "é€ƒé¿ã€æƒ…ç»ªä¸ç¨³ã€ç©ºæƒ³"},
      {"name": "Knight of Cups", "upright": "æµªæ¼«ã€ç†æƒ³ä¸»ä¹‰ã€è¿½æ¢¦", "reversed": "æ¬ºéª—ã€è™šä¼ªã€å¤±æœ›"},
      {"name": "Queen of Cups", "upright": "æ¸©æŸ”ã€ç†è§£ã€ç›´è§‰å¼º", "reversed": "æƒ…ç»ªåŒ–ã€ä¾èµ–ã€é€ƒé¿"},
      {"name": "King of Cups", "upright": "æ™ºæ…§ã€æƒ…æ„Ÿæˆç†Ÿã€å¹³è¡¡", "reversed": "å†·æ¼ ã€æ§åˆ¶æ¬²ã€å‹æŠ‘æƒ…æ„Ÿ"}
    ],
    "Swords": [
      {"name": "Ace of Swords", "upright": "çœŸç›¸ã€ç†æ€§ã€çªç ´", "reversed": "æ··ä¹±ã€è¯¯å¯¼ã€çŠ¹è±«"},
      {"name": "Two of Swords", "upright": "å¹³è¡¡ã€çŠ¹è±«ã€é€‰æ‹©", "reversed": "å†³ç­–ã€çœŸç›¸æ­ç¤ºã€å›°å¢ƒ"},
      {"name": "Three of Swords", "upright": "å¿ƒç¢ã€åˆ†ç¦»ã€ç—›è‹¦", "reversed": "ç–—æ„ˆã€æ¢å¤ã€å’Œè§£"},
      {"name": "Four of Swords", "upright": "ä¼‘æ¯ã€æ¢å¤ã€æ²‰æ€", "reversed": "ç„¦è™‘ã€è¿‡åŠ³ã€æ— æ³•æ”¾æ¾"},
      {"name": "Five of Swords", "upright": "å†²çªã€èƒŒå›ã€èƒœåˆ©çš„ä»£ä»·", "reversed": "å’Œè§£ã€åæ€ã€ç»“æŸçº·äº‰"},
      {"name": "Six of Swords", "upright": "è¿‡æ¸¡ã€ç¦»å¼€å›°å¢ƒã€æ—…è¡Œ", "reversed": "åœæ»ã€æŠ—æ‹’ã€é€ƒé¿ç°å®"},
      {"name": "Seven of Swords", "upright": "ç­–ç•¥ã€éšç§˜è¡ŒåŠ¨ã€æ™ºæ…§", "reversed": "æ­éœ²ã€å¤±è¯¯ã€å¦è¯š"},
      {"name": "Eight of Swords", "upright": "æŸç¼šã€é™åˆ¶ã€ææƒ§", "reversed": "è§£æ”¾ã€å‹‡æ°”ã€æ¸…é†’"},
      {"name": "Nine of Swords", "upright": "ç„¦è™‘ã€å™©æ¢¦ã€å¿§è™‘", "reversed": "è§£è„±ã€æ¢å¤ã€å¸Œæœ›"},
      {"name": "Ten of Swords", "upright": "ç»ˆç»“ã€å´©æºƒã€èƒŒå›", "reversed": "é‡ç”Ÿã€æ¢å¤ã€æ”¾ä¸‹"},
      {"name": "Page of Swords", "upright": "å¥½å¥‡ã€æœºæ™ºã€æ²Ÿé€š", "reversed": "æŒ‘å‰”ã€å…«å¦ã€è½»ç‡"},
      {"name": "Knight of Swords", "upright": "æœæ–­ã€è¡ŒåŠ¨åŠ›ã€å†²åŠ²", "reversed": "å†²åŠ¨ã€æ€¥èºã€é²è½"},
      {"name": "Queen of Swords", "upright": "ç†æ€§ã€ç‹¬ç«‹ã€æ´å¯Ÿ", "reversed": "å†·æ¼ ã€å­¤ç«‹ã€åæ‰§"},
      {"name": "King of Swords", "upright": "æ™ºæ…§ã€æƒå¨ã€é€»è¾‘", "reversed": "æ»¥æƒã€å†·é…·ã€åˆ»æ¿"}
    ],
    "Pentacles": [
      {"name": "Ace of Pentacles", "upright": "è´¢å¯Œæœºé‡ã€ç¨³å®šå¼€ç«¯", "reversed": "é”™å¤±æœºä¼šã€å»¶è¿Ÿã€æµªè´¹"},
      {"name": "Two of Pentacles", "upright": "å¹³è¡¡ã€çµæ´»ã€é€‚åº”", "reversed": "æ··ä¹±ã€è¶…è´Ÿè·ã€ä¼˜å…ˆå¤±è°ƒ"},
      {"name": "Three of Pentacles", "upright": "åˆä½œã€æŠ€èƒ½ã€åŠªåŠ›æˆæœ", "reversed": "ç¼ºä¹å›¢é˜Ÿã€ç–å¿½ã€ä½æ•ˆ"},
      {"name": "Four of Pentacles", "upright": "æ§åˆ¶ã€èŠ‚ä¿­ã€å®‰å…¨æ„Ÿ", "reversed": "è´ªå©ªã€ææƒ§å¤±å»ã€å›ºæ‰§"},
      {"name": "Five of Pentacles", "upright": "è´«å›°ã€å­¤ç«‹ã€è€ƒéªŒ", "reversed": "æ¢å¤ã€æ´åŠ©ã€å¸Œæœ›"},
      {"name": "Six of Pentacles", "upright": "ç»™äºˆã€å¹³è¡¡ã€æ…·æ…¨", "reversed": "ä¸å¹³ç­‰ã€è‡ªç§ã€å€ºåŠ¡"},
      {"name": "Seven of Pentacles", "upright": "è€å¿ƒã€è¯„ä¼°ã€æ”¶è·å‰çš„ç­‰å¾…", "reversed": "ä¸è€çƒ¦ã€æ— æˆæœã€æµªè´¹"},
      {"name": "Eight of Pentacles", "upright": "å‹¤å¥‹ã€ä¸“æ³¨ã€å­¦ä¹ ", "reversed": "æ‡’æ•£ã€ç²—å¿ƒã€ç¼ºä¹æŠ€å·§"},
      {"name": "Nine of Pentacles", "upright": "ç‹¬ç«‹ã€å¯Œè¶³ã€è‡ªä¿¡", "reversed": "ä¾èµ–ã€å¥¢ä¾ˆã€å­¤å•"},
      {"name": "Ten of Pentacles", "upright": "ä¼ æ‰¿ã€å®¶åº­è´¢å¯Œã€æˆåŠŸ", "reversed": "æŸå¤±ã€å†²çªã€ç»§æ‰¿é—®é¢˜"},
      {"name": "Page of Pentacles", "upright": "å­¦ä¹ ã€æœºä¼šã€è®¡åˆ’", "reversed": "æ‡’æƒ°ã€æ‹–å»¶ã€ç¼ºä¹ä¸“æ³¨"},
      {"name": "Knight of Pentacles", "upright": "è´£ä»»æ„Ÿã€ç¨³å®šã€è€å¿ƒ", "reversed": "åœæ»ã€é¡½å›ºã€è¿‡äºä¿å®ˆ"},
      {"name": "Queen of Pentacles", "upright": "åŠ¡å®ã€å…³æ€€ã€å¯Œè¶³", "reversed": "ç„¦è™‘ã€è¿‡åº¦åŠ³ç´¯ã€ç¼ºä¹å®‰å…¨æ„Ÿ"},
      {"name": "King of Pentacles", "upright": "æˆåŠŸã€ç¨³å®šã€ç‰©è´¨æˆå°±", "reversed": "è´ªå©ªã€åƒµåŒ–ã€è‡ªç§"}
    ]
  }
}
;

/* ====== suit emoji ====== */
const SUIT_EMOJI = {"Major":"ğŸƒ","Wands":"ğŸ”¥","Cups":"ğŸ’§","Swords":"âš”ï¸","Pentacles":"ğŸª™"};

/* ====== å¸¸é‡ ====== */
const DEAL_SIZE = 5;
const PICKS_REQUIRED = 3;

/* ====== çŠ¶æ€ ====== */
let TAROT_DB = null, TAROT_CARDS = [], TABLE_CARDS = [], CHOSEN = [];
let busy = false, loading = false, ANIM_SPEED = 1.0, audioCtx;

const deckRoot = document.getElementById('deck'),
      statusEl = document.getElementById('status'),
      logEl = document.getElementById('log'),
      kvEl = document.getElementById('kv'),
      btnDeal = document.getElementById('deal'),
      btnReset = document.getElementById('reset'),
      btnNext = document.getElementById('next'),
      speedSlider = document.getElementById('speed'),
      speedVal = document.getElementById('speedVal'),
      picksJsonEl = document.getElementById('tarot_picks_json');

/* ====== å°éŸ³æ•ˆ ====== */
function ping(f=880,d=0.06,v=0.08){
  try{
    audioCtx ||= new (window.AudioContext||window.webkitAudioContext)();
    const o=audioCtx.createOscillator(),g=audioCtx.createGain();
    o.type='triangle';o.frequency.value=f;g.gain.value=v;
    o.connect(g).connect(audioCtx.destination);o.start();
    setTimeout(()=>o.stop(),d*1000);
  }catch(e){}
}

/* ====== æ•°æ®æ•´å½¢ï¼ˆå®¹é”™ï¼‰ ====== */
function safeStr(x, d=""){ return (typeof x === "string" ? x : (x==null?d:String(x))); }
function normalizeTarot(json){
  const out=[];
  try{
    if(Array.isArray(json.Major_Arcana)){
      for(const m of json.Major_Arcana){
        if(m==null) continue;
        const num = Number(m.number);
        const nameEn = safeStr(m.name_en, "");
        const nameZh = safeStr(m.name_zh, "");
        out.push({
          id:`major-${isFinite(num)?num:nameEn||nameZh||'X'}`,
          title:nameEn || nameZh || `Major ${isFinite(num)?num:'?'}`,
          title_zh:nameZh || nameEn || `ä¸»ç‰Œ ${isFinite(num)?num:'?'}`,
          arcana:"Major", suit:"Major", rank:isFinite(num)?num:0,
          upright:safeStr(m.upright), reversed:safeStr(m.reversed), emoji:SUIT_EMOJI["Major"]
        });
      }
    }
    const minors=json.Minor_Arcana||{};
    for(const suit of ["Wands","Cups","Swords","Pentacles"]){
      const arr=minors[suit]||[];
      for(const it of arr){
        if(it==null) continue;
        const nm = safeStr(it.name, "");
        if(!nm) continue;
        out.push({
          id:`${suit}-${nm}`,
          title:nm,
          title_zh:safeStr(it.name_zh, nm),
          arcana:"Minor", suit, rank:nm.split(" ")[0],
          upright:safeStr(it.upright), reversed:safeStr(it.reversed), emoji:SUIT_EMOJI[suit]
        });
      }
    }
  }catch(e){
    console.error("normalizeTarot error:", e);
  }
  return out;
}

/* ====== åŠ è½½å¡ç»„ï¼ˆä¸¥æ ¼æ—¶åº + é”æŒ‰é’®ï¼‰ ====== */
async function loadTarotDB(){
  if(loading) return TAROT_CARDS.length>0;
  loading = true;
  btnDeal.disabled = true; btnDeal.textContent = "â³ æ­£åœ¨è½½å…¥â€¦";
  try{
    const res = await fetch(TAROT_JSON_URL, {cache:"no-store"});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();         // Acknowledged: matches your provided format
    TAROT_DB = data;
    TAROT_CARDS = normalizeTarot(TAROT_DB);
    statusEl.textContent = `å·²è½½å…¥ ${TAROT_CARDS.length} å¼ å¡ç‰Œï¼ˆå¤–éƒ¨ JSONï¼‰`;
    if(!TAROT_CARDS.length) throw new Error("å¡ç»„ä¸ºç©ºï¼ˆè§£æåï¼‰");
    return true;
  }catch(e){
    console.warn("å¤–éƒ¨ Cards.json è¯»å–å¤±è´¥ï¼Œä½¿ç”¨å†…ç½®åå¤‡ï¼š", e);
    TAROT_DB = FALLBACK_JSON;
    TAROT_CARDS = normalizeTarot(FALLBACK_JSON);
    statusEl.textContent = 'å·²å¯ç”¨å†…ç½®å¡ç»„ï¼ˆåå¤‡ï¼‰';
    logEl.textContent = 'å¤–éƒ¨ Cards.json è¯»å–å¤±è´¥æˆ–ä¸ºç©ºã€‚';
    return true; // ç»§ç»­æµç¨‹
  }finally{
    btnDeal.disabled = false; btnDeal.textContent = "ğŸƒ å‘ 5 å¼ ";
    loading = false;
  }
}

/* ====== åŠ¨ç”»å·¥å…· ====== */
function placeCard(el,sh,x,y,rot,z=0){
  el.style.transform=`translate(${x-90}px,${y-130}px) rotate(${rot}deg) translateZ(${z}px)`;
  sh.style.left=x+'px'; sh.style.top=(y+120)+'px';
  sh.style.opacity=Math.max(0,Math.min(1,(z/160)));
  sh.style.transform=`translate(-50%,-50%) scale(${1+z/220})`;
}
function animateP(d,step){
  d/=ANIM_SPEED;
  return new Promise(r=>{
    const t0=performance.now();
    (function a(t){
      const k=Math.min(1,(t-t0)/d);
      step(k);
      k<1?requestAnimationFrame(a):r();
    })(performance.now());
  });
}
const lerp=(a,b,t)=>a+(b-a)*t;
const easeOutCubic=t=>1-Math.pow(1-t,3);

/* ====== éšæœº ====== */
function shuffle(arr){
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
  return a;
}
function randomOrientation(){ return Math.random()<0.5 ? 'upright' : 'reversed'; }

/* ====== ç»“æœ JSON ====== */
function xId(meta){ return meta.id || `${meta.suit||meta.arcana}-${meta.title}`; }
function buildResultJSON(){
  return {
    timestamp: new Date().toISOString(),
    runtime_id: RUNTIME_ID,
    dialog_id: DIALOG_ID,
    picks: CHOSEN.map(x=>({
      id: xId(x.card),
      name_en: x.card.title,
      name_zh: x.card.title_zh || x.card.title,
      suit: x.card.suit,
      arcana: x.card.arcana,
      orientation: x.orientation,
      meaning: (x.orientation==='upright'?x.card.upright:x.card.reversed)||""
    }))
  };
}
function updatePicksJSON(){
  const payload = (CHOSEN.length ? buildResultJSON() : {});
  picksJsonEl.textContent = JSON.stringify(payload, null, 2);
}

/* ====== å‘ 5 å¼ èƒŒé¢ ====== */
async function dealFive(){
  if(busy) return;
  if(!TAROT_CARDS.length){ console.warn('å¡ç»„ä¸ºç©ºï¼Œå–æ¶ˆå‘ç‰Œ'); return; }
  busy = true;
  try{
    btnNext.disabled=true; CHOSEN.length=0; kvEl.textContent="";
    deckRoot.innerHTML=''; TABLE_CARDS.length=0;
    updatePicksJSON();

    const five=shuffle(TAROT_CARDS).slice(0,DEAL_SIZE);
    const center={x:320,y:180};
    for(const d of five){
      const el=document.createElement('div'); el.className='card back';
      el.innerHTML=`<div class="sigil">âœ¦ âœ§ âœ¦</div>`;
      const sh=document.createElement('div'); sh.className='shadow';
      deckRoot.append(sh,el);
      placeCard(el,sh,center.x,center.y,Math.random()*10-5,0);
      TABLE_CARDS.push({el,sh,meta:d,x:center.x,y:center.y,rot:(Math.random()*8-4),picked:false});
    }

    const startX=80, spacing=110, baseY=250;
    statusEl.textContent='é™å¿ƒå‡è§†ï¼Œé€‰æ‹©ä¸ä½ å¯¹è¯çš„ä¸‰å¼ ã€‚';
    logEl.textContent='è½»è§¦å¡é¢å®Œæˆé€‰æ‹©ã€‚';

    for(let i=0;i<TABLE_CARDS.length;i++){
      const c=TABLE_CARDS[i];
      c.el.style.zIndex=100+i;
      await animateP(380,t=>{
        const e=easeOutCubic(t);
        const x=lerp(c.x,startX+i*spacing,e);
        const y=lerp(c.y,baseY,e);
        const rot=lerp(c.rot,(i-2)*4,e);
        placeCard(c.el,c.sh,x,y,rot,60*Math.sin(e*Math.PI));
        c.el.style.opacity=1;
      });
      // ensure on top & clickable
      c.el.style.pointerEvents = 'auto';
      c.el.onclick=()=>onPick(c);
    }
  }catch(err){
    console.error("dealFive error:", err);
    logEl.textContent = 'å‘ç‰Œå¤±è´¥ï¼š' + err;
  }finally{
    busy=false;
  }
}

/* ====== é€‰æ‹© 3 å¼  ====== */
function onPick(card){
  if(card.picked || CHOSEN.length>=PICKS_REQUIRED) return;
  card.picked=true;
  card.el.classList.add('selected');
  CHOSEN.push({ card:card.meta, orientation:randomOrientation() });
  ping(640,.05,.07);

  const remain=PICKS_REQUIRED-CHOSEN.length;
  statusEl.textContent = remain>0 ? `å·²é€‰ ${CHOSEN.length} å¼ ï¼Œè¿˜éœ€ ${remain} å¼ ` : `é€‰æ‹©å®Œæˆ`;

  updatePicksJSON();

  if(CHOSEN.length===PICKS_REQUIRED){
    TABLE_CARDS.forEach(c=>{ if(!c.picked) c.el.onclick=null; });
    dropUnselectedAndFocus();
  }
}

/* ====== æœªé€‰ä¸‹è½ï¼Œå·²é€‰å±…ä¸­ ====== */
async function dropUnselectedAndFocus(){
  busy=true;
  const unpicked = TABLE_CARDS.filter(c=>!c.picked);
  const picked   = TABLE_CARDS.filter(c=>c.picked);

  await Promise.all(unpicked.map(c => animateP(520, t => {
    const e = easeOutCubic(t);
    const ny = c.y + e*220;
    c.el.style.opacity = 1 - e;
    c.el.style.filter = `blur(${e*2.5}px) grayscale(${e*.3})`;
    placeCard(c.el, c.sh, c.x, ny, c.rot, 0);
  })));
  unpicked.forEach(c => { c.el.remove(); c.sh.remove(); });

  const baseY = 190, spacing = 170, total = picked.length;
  const startX = 320 - ((total-1)*spacing)/2;

  for (let i=0;i<picked.length;i++){
    const c = picked[i];
    c.el.classList.add('focused');
    c.el.style.zIndex = 200 + i;
    const targetX = startX + i*spacing;
    const targetY = baseY;
    await animateP(420, t => {
      const e = easeOutCubic(t);
      const x = lerp(c.x, targetX, e);
      const y = lerp(c.y, targetY, e);
      const rot = lerp(c.rot, 0, e);
      placeCard(c.el, c.sh, x, y, rot, 60 * Math.sin(e*Math.PI));
      c.el.style.opacity = 1;
    });
    c.x = startX + i*spacing; c.y = baseY; c.rot = 0;
  }

  await revealChosenCentered(picked);
  busy=false;
}

/* ====== ç¿»å¼€ä¸‰å¼  ====== */
async function revealChosenCentered(picked){
  logEl.textContent='å¡é¢å³æ™¯ï¼Œå¯“æ„å°†è‡³ã€‚';
  for(const c of picked){
    const chosen = CHOSEN.find(k=>xId(k.card)===xId(c.meta));
    if(!chosen) continue;
    const orient = chosen.orientation;
    const baseTransform = c.el.style.transform || '';

    await animateP(220, t=>{
      const angle = 90 * t;
      c.el.style.transform = `${baseTransform} rotateY(${angle}deg) scale(1.04)`;
    });

    c.el.classList.remove('back');
    const title = c.meta.title_zh || c.meta.title;
    const meaning = (orient==='upright' ? c.meta.upright : c.meta.reversed) || '';
    c.el.innerHTML = `
      <div class="tag">${c.meta.suit || c.meta.arcana} Â· ${orient==='upright'?'æ­£ä½':'é€†ä½'}</div>
      <div class="title">${title}</div>
      <div class="emoji">${c.meta.emoji || 'ğŸƒ'}</div>
      <div class="tiny">${meaning.slice(0,28)}${meaning.length>28?'â€¦':''}</div>
    `;

    await animateP(220, t=>{
      const angle = 90 + 90 * t;
      c.el.style.transform = `${baseTransform} rotateY(${angle}deg) scale(1.08)`;
    });
    c.el.style.transform = `${baseTransform} scale(1.08)`;
  }

  const summary = CHOSEN.map((x,i)=>`${i+1}. ${x.card.title_zh||x.card.title}ï¼ˆ${x.orientation==='upright'?'æ­£ä½':'é€†ä½'}ï¼‰`).join('ï¼› ');
  statusEl.textContent = 'ä¸‰è±¡å·²ç°';
  logEl.textContent = 'ç‚¹å‡»ã€Œè¿›å…¥å¯¹è¯ã€ï¼Œè®©ç­”æ¡ˆç¼“ç¼“å±•å¼€ã€‚';
  kvEl.innerHTML = `<b>é€‰ä¸­ï¼š</b> ${summary}`;

  updatePicksJSON();
  btnNext.disabled = false;
}

/* ====== è¿›å…¥å¯¹è¯ ====== */
async function enterConversation(){
  if(CHOSEN.length !== 3){ alert('è¯·å…ˆé€‰æ»¡ 3 å¼ å¡ç‰Œã€‚'); return; }
  const result = buildResultJSON();
  const picks = result.picks;

  localStorage.setItem('tarot_picks', JSON.stringify(result));
  localStorage.setItem('tarot_runtime_id', RUNTIME_ID);
  DIALOG_ID = newDialogId();
  localStorage.setItem('tarot_dialog_id', DIALOG_ID);

  updatePicksJSON();

  try{
    const r = await fetch(`${BACKEND_URL}/api/dialog/init`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ runtime_id: RUNTIME_ID, dialog_id: DIALOG_ID, cards: picks })
    });
    if(!r.ok){
      console.warn('Init failed', await r.text());
    }
  }catch(e){ console.warn('Backend not reachable for init.', e); }

  window.location.href = RAG_HTML_URL;
}

/* ====== äº¤äº’ç»‘å®šï¼ˆä¸¥æ ¼ç­‰å¾…åŠ è½½ï¼‰ ====== */
btnDeal.addEventListener('click', async ()=>{
  if(busy || loading) return;
  const ok = await loadTarotDB();
  if(ok && TAROT_CARDS.length>0) await dealFive();
});

btnReset.addEventListener('click',()=>{
  TABLE_CARDS.length=0; CHOSEN.length=0; deckRoot.innerHTML='';
  kvEl.textContent=''; statusEl.textContent='è½»æŒ‰å¼€å§‹ï¼Œå€¾å¬å¿ƒæ„'; logEl.textContent='æ·±å‘¼å¸ï¼Œä¸“æ³¨ä½ çš„å½“ä¸‹é—®é¢˜ã€‚';
  btnNext.disabled=true;
  updatePicksJSON();
});

btnNext.addEventListener('click', enterConversation);
speedSlider.addEventListener('input',e=>{ ANIM_SPEED=parseFloat(e.target.value); speedVal.textContent=ANIM_SPEED.toFixed(1)+'Ã—'; });

/* ====== å¯åŠ¨ ====== */
(async function start(){
  speedVal.textContent = speedSlider.value+'Ã—';
  statusEl.textContent='å¡ç»„å°±ç»ªï¼ˆç‚¹å‡»å‘ 5 å¼ ï¼‰';
  updatePicksJSON();
})();
</script>
</body>
</html>
